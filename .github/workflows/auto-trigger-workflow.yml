name: Auto Convert Scripts

on:
  push:
    branches: [ main ]
    paths:
      - 'QX/**/*.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'QX/**/*.js'
  workflow_dispatch:  # Allows manual triggering

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Download script_converter.py
      run: |
        curl -o script_converter.py https://raw.githubusercontent.com/Mikephie/AutomatedJS/script-converter/script_converter.py
        chmod +x script_converter.py
        ls -la script_converter.py
    
    - name: Create test directories and files
      run: |
        # Create QX directory if it doesn't exist
        mkdir -p QX
        
        # Create output directories
        mkdir -p Loon
        mkdir -p Surge
        
        # List directories to verify
        echo "Directory structure:"
        find . -type d | sort
        echo "Files in QX directory:"
        find QX -type f | sort
    
    - name: Run conversion script
      run: |
        echo "Executing script_converter.py with QX directory"
        python script_converter.py QX
        
        # List generated files
        echo "Generated files:"
        find Loon -type f | sort
        find Surge -type f | sort
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Loon/ Surge/
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-convert scripts [skip ci]"
          git push
        fi
